"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@stoplight/json"),t=require("@stoplight/lifecycle");let r=0;class s{constructor(e){this.fragment=e,this.parent=null,this.id=String(r++),this.subpath=[]}get path(){return null===this.parent?this.subpath:[...this.parent.path,...this.subpath]}get depth(){return null===this.parent?0:this.parent.depth+1}}class n extends s{constructor(e){super(e.fragment),this.mirrors=e}get children(){if(!("children"in this.mirrors))return null;const e=this.mirrors.children;if(null===e)return null;const t=[];for(const r of e){const e=new n(r);e.parent=this,t.push(e)}return t}}function i(e){return"string"==typeof e?e:null}class o extends s{constructor(e,t){super(e),this.error=t,this.value=i(e.$ref)}get external(){return null!==this.value&&!e.isLocalRef(this.value)}}function l(e,t){const r={};for(const s of t)s in e&&(r[s]=e[s]);return r}const h=["description","default","examples"];var a,c;function p(e){return"string"==typeof e||"number"==typeof e}function u(e){return null!=e&&"object"==typeof e}function f(e){if(!0==("function"!=typeof(t=e)&&!u(t)))return!1;var t;const r=Object.getPrototypeOf(e);return null===r||r===Object.prototype}(a=exports.SchemaNodeKind||(exports.SchemaNodeKind={})).Any="any",a.String="string",a.Number="number",a.Integer="integer",a.Boolean="boolean",a.Null="null",a.Array="array",a.Object="object",(c=exports.SchemaCombinerName||(exports.SchemaCombinerName={})).AllOf="allOf",c.AnyOf="anyOf",c.OneOf="oneOf";const m=["id","$schema"];const d=Object.values(exports.SchemaNodeKind),g=e=>"string"==typeof e&&d.includes(e);function y(e){if("type"in e){if(Array.isArray(e.type))return e.type.filter(g);if(g(e.type))return[e.type]}const t=function(e){return"properties"in e||"additionalProperties"in e||"patternProperties"in e?exports.SchemaNodeKind.Object:"items"in e||"additionalItems"in e?exports.SchemaNodeKind.Array:null}(e);return null!==t?[t]:null}const x=["default","example","nullable","discriminator","readOnly","writeOnly","xml","externalDocs"],N={string:["minLength","maxLength","pattern"],number:["multipleOf","minimum","exclusiveMinimum","maximum","exclusiveMaximum"],get integer(){return this.number},object:["additionalProperties","minProperties","maxProperties"],array:["additionalItems","minItems","maxItems","uniqueItems"]};function O(e,t){const r=null===t?null:function(e){let t=null;for(const r of e){const e=N[r];void 0!==e&&(null!=t||(t=[]),t.push(...e))}return t}(t);return Object.assign(Object.assign({},l(e,x)),null!==r?l(e,r):null)}class v extends s{constructor(e){var t,r,s;super(e),this.fragment=e,this.types=y(e),this.primaryType=null!==(t=this.types)?t.includes(exports.SchemaNodeKind.Object)?exports.SchemaNodeKind.Object:t.includes(exports.SchemaNodeKind.Array)?exports.SchemaNodeKind.Array:t.length>0?t[0]:null:null,this.combiners=function(e){let t=null;return exports.SchemaCombinerName.AnyOf in e&&(null!=t||(t=[]),t.push(exports.SchemaCombinerName.AnyOf)),exports.SchemaCombinerName.OneOf in e&&(null!=t||(t=[]),t.push(exports.SchemaCombinerName.OneOf)),exports.SchemaCombinerName.AllOf in e&&(null!=t||(t=[]),t.push(exports.SchemaCombinerName.AllOf)),t}(e),this.deprecated=function(e){return"x-deprecated"in e?!0===e["x-deprecated"]:"deprecated"in e&&!0===e.deprecated}(e),this.enum=(r=e.enum,Array.isArray(r)?r:null),this.required=(s=e.required,Array.isArray(s)?s.filter(p).map(String):null),this.format=i(e.format),this.title=i(e.title),this.meta=function(e){return l(e,m)}(e),this.annotations=function(e){return l(e,h)}(e),this.validations=O(e,this.types),this.children=null}get simple(){return this.primaryType!==exports.SchemaNodeKind.Array&&this.primaryType!==exports.SchemaNodeKind.Object&&null===this.combiners}}class b extends s{constructor(e){super(e),this.fragment=e,this.parent=null,this.children=[]}}class w extends ReferenceError{constructor(){super(...arguments),this.name="ResolvingError"}}const A=require("@stoplight/json-schema-merge-allof"),S=new WeakMap;function k(t,r,s){try{return null===s.resolveRef||S.has(s.resolveRef)||S.set(s.resolveRef,new WeakMap),function t(r,s,n){return A(r,Object.assign({deep:!1,resolvers:A.stoplightResolvers},null!==n?{$refResolver(i){if("string"!=typeof i)return{};if(e.pathToPointer(s).startsWith(i))throw new w("Circular reference detected");const o=S.get(n);let l=o.get(r);if(void 0===l)l=[i],o.set(r,l);else{if(l.includes(i)){const r=JSON.parse(e.stringify(n(null,i)));return"allOf"in r?t(r,s,n):r}l.push(i)}const h=n(null,i);if(Array.isArray(h.allOf))for(const e of h.allOf)if("string"==typeof e.$ref&&l.includes(e.$ref))throw new w("Circular reference detected");return h}}:null))}(t,r,s.resolveRef)}catch(e){throw console.info(e.message),e}}class R extends t.EventEmitter{constructor(e,t){super(),this.root=e,this.walkingOptions=t,this.path=[],this.depth=-1,this.fragment=e.fragment,this.schemaNode=e,this.processedFragments=new WeakMap,this.hooks={}}*resume(e){this.path.splice(0,this.path.length,...e.path),this.depth=e.depth,this.fragment=e.fragment,this.schemaNode=e.schemaNode,yield*this.walk()}pause(){return{depth:this.depth,fragment:this.fragment,schemaNode:this.schemaNode,path:this.path.slice()}}hookInto(e,t){this.hooks[e]=t}restoreWalkerAtNode(e){this.path.splice(0,this.path.length,...e.path),this.depth=e.depth,this.fragment=e.fragment,this.schemaNode=e}*walk(){var e,t,r,s;const{depth:n,schemaNode:i,path:{length:o}}=this;for(const o of this.processFragment()){super.emit("newNode",o),this.processedFragments.set(o.fragment,o),this.fragment=o.fragment,this.depth=n+1,!0!==(null===(t=(e=this.hooks).filter)||void 0===t?void 0:t.call(e,o))&&(o.parent=i,o.subpath=this.path.slice(i.path.length),"children"in i&&(null===i.children?i.children=[o]:i.children.push(o)),super.emit("acceptNode",o),o instanceof v&&(this.schemaNode=o,!1!==(null===(s=(r=this.hooks).stepIn)||void 0===s?void 0:s.call(r,o))&&(super.emit("enterNode",o),yield*this.walkNodeChildren())),super.emit("exitNode",o))}this.path.length=o,this.depth=n,this.schemaNode=i}*walkNodeChildren(){const{fragment:e,schemaNode:t}=this;if(!(t instanceof v))return;const{depth:r,schemaNode:s,path:{length:n}}=this;if(null!==t.combiners)for(const i of t.combiners){const t=e[i];if(!Array.isArray(t))continue;let o=-1;for(const e of t)o++,f(e)&&(this.fragment=e,this.schemaNode=s,this.depth=r,this.path.length=n,this.path.push(i,String(o)),yield*this.walk())}switch(t.primaryType){case exports.SchemaNodeKind.Array:if(Array.isArray(e.items)){let t=-1;for(const i of e.items)t++,f(i)&&(this.fragment=i,this.schemaNode=s,this.depth=r,this.path.length=n,this.path.push("items",String(t)),yield*this.walk())}else f(e.items)&&(this.schemaNode=s,this.depth=r,this.path.length=n,this.fragment=e.items,this.path.push("items"),yield*this.walk());break;case exports.SchemaNodeKind.Object:if(f(e.properties))for(const t of Object.keys(e.properties)){const i=e.properties[t];f(i)&&(this.fragment=i,this.schemaNode=s,this.depth=r,this.path.length=n,this.path.push("properties",t),yield*this.walk())}if(f(e.patternProperties))for(const t of Object.keys(e.patternProperties)){const i=e.patternProperties[t];f(i)&&(this.schemaNode=s,this.depth=r,this.path.length=n,this.fragment=i,this.path.push("patternProperties",t),yield*this.walk())}}this.schemaNode=t}*processFragment(){var e;const{walkingOptions:t,path:r,processedFragments:s}=this;let{fragment:i}=this;const l=s.get(i);if(void 0!==l)return yield new n(l);if("$ref"in i){if(null===t.resolveRef||"string"!=typeof i.$ref)return yield new o(i,null);try{i=t.resolveRef(r,i.$ref)}catch(t){return yield new o(i,null!==(e=null==t?void 0:t.message)&&void 0!==e?e:"Unknown resolving error")}}if(t.mergeAllOf&&exports.SchemaCombinerName.AllOf in i)try{i=k(i,r,t)}catch(e){}if(exports.SchemaCombinerName.OneOf in i||exports.SchemaCombinerName.AnyOf in i)try{for(const e of function(e,t,r){const s=exports.SchemaCombinerName.OneOf in e?exports.SchemaCombinerName.OneOf:exports.SchemaCombinerName.AnyOf,n=e[s];if(!Array.isArray(n))return[];const i=[];if(Array.isArray(e.allOf)&&Array.isArray(n)){for(const t of n)i.push({allOf:[...e.allOf,t]});return i}for(const o of n){const n=Object.assign({},e);delete n[s];const l="string"==typeof o.$ref&&null!==r.resolveRef?r.resolveRef(null,o.$ref):o;if(0===Object.keys(n).length)i.push(l);else{const e={allOf:[n,l]};try{i.push(k(e,t,r))}catch(t){i.push(e)}}}return i}(i,r,t))yield new v(e);return}catch(e){}yield new v(i)}}exports.BaseNode=s,exports.MirrorNode=n,exports.ReferenceNode=o,exports.RegularNode=v,exports.RootNode=b,exports.SchemaTree=class{constructor(t,r){var s;this.schema=t,this.opts=r,this.resolveRef=(e,t)=>{const r=[];let s,n=t;for(;"string"==typeof n&&!r.includes(n);)r.push(n),s=this._resolveRef(e,n),n=s.$ref;return s},this._resolveRef=(t,r)=>{var s;const n=e.extractSourceFromRef(r),i=e.extractPointerFromRef(r),{refResolver:o}=null!==(s=this.opts)&&void 0!==s?s:{};if("function"==typeof o)return o({source:n,pointer:i},t,this.schema);if(null!==n)throw new w("Cannot dereference external references");if(null===i)throw new w("The pointer is empty");{const t=function(e,t){if(0===t.length)return e;let r=e;for(let e=0;e<t.length-1;e++){if(r=r[t[e]],!u(r))return}return r[t[t.length-1]]}(this.schema,e.pointerToPath(i));if(!f(t))throw new w("Invalid value");return t}},this.root=new b(t),this.walker=new R(this.root,{mergeAllOf:!1!==(null===(s=this.opts)||void 0===s?void 0:s.mergeAllOf),resolveRef:null===(null==r?void 0:r.refResolver)?null:this.resolveRef})}populate(){this.invokeWalker(this.walker)}invokeWalker(e){const t=e.walk();for(;!t.next().done;);}};
//# sourceMappingURL=index.cjs.js.map
