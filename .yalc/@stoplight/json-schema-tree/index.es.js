import{isLocalRef as e,pathToPointer as t,stringify as r,extractSourceFromRef as n,extractPointerFromRef as s,pointerToPath as i}from"@stoplight/json";import{EventEmitter as l}from"@stoplight/lifecycle";let o=0;class h{constructor(e){this.fragment=e,this.parent=null,this.id=String(o++),this.subpath=[]}get path(){return null===this.parent?this.subpath:[...this.parent.path,...this.subpath]}get depth(){return null===this.parent?0:this.parent.depth+1}}class a extends h{constructor(e){super(e.fragment),this.mirrors=e}get children(){if(!("children"in this.mirrors))return null;const e=this.mirrors.children;if(null===e)return null;const t=[];for(const r of e){const e=new a(r);e.parent=this,t.push(e)}return t}}function c(e){return"string"==typeof e?e:null}class u extends h{constructor(e,t){super(e),this.error=t,this.value=c(e.$ref)}get external(){return null!==this.value&&!e(this.value)}}function f(e,t){const r={};for(const n of t)n in e&&(r[n]=e[n]);return r}const p=["description","default","examples"];var d,m;function g(e){return"string"==typeof e||"number"==typeof e}function y(e){return null!=e&&"object"==typeof e}function O(e){if(!0==("function"!=typeof(t=e)&&!y(t)))return!1;var t;const r=Object.getPrototypeOf(e);return null===r||r===Object.prototype}!function(e){e.Any="any",e.String="string",e.Number="number",e.Integer="integer",e.Boolean="boolean",e.Null="null",e.Array="array",e.Object="object"}(d||(d={})),function(e){e.AllOf="allOf",e.AnyOf="anyOf",e.OneOf="oneOf"}(m||(m={}));const v=["id","$schema"];const w=Object.values(d),A=e=>"string"==typeof e&&w.includes(e);function b(e){if("type"in e){if(Array.isArray(e.type))return e.type.filter(A);if(A(e.type))return[e.type]}const t=function(e){return"properties"in e||"additionalProperties"in e||"patternProperties"in e?d.Object:"items"in e||"additionalItems"in e?d.Array:null}(e);return null!==t?[t]:null}const k=["default","example","nullable","discriminator","readOnly","writeOnly","xml","externalDocs"],N={string:["minLength","maxLength","pattern"],number:["multipleOf","minimum","exclusiveMinimum","maximum","exclusiveMaximum"],get integer(){return this.number},object:["additionalProperties","minProperties","maxProperties"],array:["additionalItems","minItems","maxItems","uniqueItems"]};function x(e,t){const r=null===t?null:function(e){let t=null;for(const r of e){const e=N[r];void 0!==e&&(null!=t||(t=[]),t.push(...e))}return t}(t);return Object.assign(Object.assign({},f(e,k)),null!==r?f(e,r):null)}class j extends h{constructor(e){var t,r,n;super(e),this.fragment=e,this.types=b(e),this.primaryType=null!==(t=this.types)?t.includes(d.Object)?d.Object:t.includes(d.Array)?d.Array:t.length>0?t[0]:null:null,this.combiners=function(e){let t=null;return m.AnyOf in e&&(null!=t||(t=[]),t.push(m.AnyOf)),m.OneOf in e&&(null!=t||(t=[]),t.push(m.OneOf)),m.AllOf in e&&(null!=t||(t=[]),t.push(m.AllOf)),t}(e),this.deprecated=function(e){return"x-deprecated"in e?!0===e["x-deprecated"]:"deprecated"in e&&!0===e.deprecated}(e),this.enum=(r=e.enum,Array.isArray(r)?r:null),this.required=(n=e.required,Array.isArray(n)?n.filter(g).map(String):null),this.format=c(e.format),this.title=c(e.title),this.meta=function(e){return f(e,v)}(e),this.annotations=function(e){return f(e,p)}(e),this.validations=x(e,this.types),this.children=null}get simple(){return this.primaryType!==d.Array&&this.primaryType!==d.Object&&null===this.combiners}}class R extends h{constructor(e){super(e),this.fragment=e,this.parent=null,this.children=[]}}function $(){}class P extends ReferenceError{constructor(){super(...arguments),this.name="ResolvingError"}}const I=require("@stoplight/json-schema-merge-allof"),W=new WeakMap;function S(e,n,s){try{return null===s.resolveRef||W.has(s.resolveRef)||W.set(s.resolveRef,new WeakMap),function e(n,s,i){return I(n,Object.assign({deep:!1,resolvers:I.stoplightResolvers},null!==i?{$refResolver(l){if("string"!=typeof l)return{};if(t(s).startsWith(l))throw new P("Circular reference detected");const o=W.get(i);let h=o.get(n);if(void 0===h)h=[l],o.set(n,h);else{if(h.includes(l)){const t=JSON.parse(r(i(null,l)));return"allOf"in t?e(t,s,i):t}h.push(l)}const a=i(null,l);if(Array.isArray(a.allOf))for(const e of a.allOf)if("string"==typeof e.$ref&&h.includes(e.$ref))throw new P("Circular reference detected");return a}}:null))}(e,n,s.resolveRef)}catch(e){throw console.info(e.message),e}}class C extends l{constructor(e,t){super(),this.root=e,this.walkingOptions=t,this.path=[],this.depth=-1,this.fragment=e.fragment,this.schemaNode=e,this.processedFragments=new WeakMap,this.hooks={}}*resume(e){this.path.splice(0,this.path.length,...e.path),this.depth=e.depth,this.fragment=e.fragment,this.schemaNode=e.schemaNode,yield*this.walk()}pause(){return{depth:this.depth,fragment:this.fragment,schemaNode:this.schemaNode,path:this.path.slice()}}hookInto(e,t){this.hooks[e]=t}restoreWalkerAtNode(e){this.path.splice(0,this.path.length,...e.path),this.depth=e.depth,this.fragment=e.fragment,this.schemaNode=e}*walk(){var e,t,r,n;const{depth:s,schemaNode:i,path:{length:l}}=this;for(const l of this.processFragment()){super.emit("newNode",l),this.processedFragments.set(l.fragment,l),this.fragment=l.fragment,this.depth=s+1,!0!==(null===(t=(e=this.hooks).filter)||void 0===t?void 0:t.call(e,l))&&(l.parent=i,l.subpath=this.path.slice(i.path.length),"children"in i&&(null===i.children?i.children=[l]:i.children.push(l)),super.emit("acceptNode",l),l instanceof j&&(this.schemaNode=l,!1!==(null===(n=(r=this.hooks).stepIn)||void 0===n?void 0:n.call(r,l))&&(super.emit("enterNode",l),yield*this.walkNodeChildren())),super.emit("exitNode",l))}this.path.length=l,this.depth=s,this.schemaNode=i}*walkNodeChildren(){const{fragment:e,schemaNode:t}=this;if(!(t instanceof j))return;const{depth:r,schemaNode:n,path:{length:s}}=this;if(null!==t.combiners)for(const i of t.combiners){const t=e[i];if(!Array.isArray(t))continue;let l=-1;for(const e of t)l++,O(e)&&(this.fragment=e,this.schemaNode=n,this.depth=r,this.path.length=s,this.path.push(i,String(l)),yield*this.walk())}switch(t.primaryType){case d.Array:if(Array.isArray(e.items)){let t=-1;for(const i of e.items)t++,O(i)&&(this.fragment=i,this.schemaNode=n,this.depth=r,this.path.length=s,this.path.push("items",String(t)),yield*this.walk())}else O(e.items)&&(this.schemaNode=n,this.depth=r,this.path.length=s,this.fragment=e.items,this.path.push("items"),yield*this.walk());break;case d.Object:if(O(e.properties))for(const t of Object.keys(e.properties)){const i=e.properties[t];O(i)&&(this.fragment=i,this.schemaNode=n,this.depth=r,this.path.length=s,this.path.push("properties",t),yield*this.walk())}if(O(e.patternProperties))for(const t of Object.keys(e.patternProperties)){const i=e.patternProperties[t];O(i)&&(this.schemaNode=n,this.depth=r,this.path.length=s,this.fragment=i,this.path.push("patternProperties",t),yield*this.walk())}}this.schemaNode=t}*processFragment(){var e;const{walkingOptions:t,path:r,processedFragments:n}=this;let{fragment:s}=this;const i=n.get(s);if(void 0!==i)return yield new a(i);if("$ref"in s){if(null===t.resolveRef||"string"!=typeof s.$ref)return yield new u(s,null);try{s=t.resolveRef(r,s.$ref)}catch(t){return yield new u(s,null!==(e=null==t?void 0:t.message)&&void 0!==e?e:"Unknown resolving error")}}if(t.mergeAllOf&&m.AllOf in s)try{s=S(s,r,t)}catch(e){}if(m.OneOf in s||m.AnyOf in s)try{const e=function(e,t,r){const n=m.OneOf in e?m.OneOf:m.AnyOf,s=e[n];if(!Array.isArray(s))return[];const i=[];if(Array.isArray(e.allOf)&&Array.isArray(s)){for(const t of s)i.push({allOf:[...e.allOf,t]});return i}for(const l of s){const s=Object.assign({},e);delete s[n];const o="string"==typeof l.$ref&&null!==r.resolveRef?r.resolveRef(null,l.$ref):l;if(0===Object.keys(s).length)i.push(o);else{const e={allOf:[s,o]};try{i.push(S(e,t,r))}catch(t){i.push(e)}}}return i}(s,r,t);return void(1===e.length?yield new j(e[0]):yield new j({[m.OneOf in s?m.OneOf:m.AnyOf]:e}))}catch(e){}yield new j(s)}}class F{constructor(e,t){var r;this.schema=e,this.opts=t,this.resolveRef=(e,t)=>{const r=[];let n,s=t;for(;"string"==typeof s&&!r.includes(s);)r.push(s),n=this._resolveRef(e,s),s=n.$ref;return n},this._resolveRef=(e,t)=>{var r;const l=n(t),o=s(t),{refResolver:h}=null!==(r=this.opts)&&void 0!==r?r:{};if("function"==typeof h)return h({source:l,pointer:o},e,this.schema);if(null!==l)throw new P("Cannot dereference external references");if(null===o)throw new P("The pointer is empty");{const e=function(e,t){if(0===t.length)return e;let r=e;for(let e=0;e<t.length-1;e++){if(r=r[t[e]],!y(r))return}return r[t[t.length-1]]}(this.schema,i(o));if(!O(e))throw new P("Invalid value");return e}},this.root=new R(e),this.walker=new C(this.root,{mergeAllOf:!1!==(null===(r=this.opts)||void 0===r?void 0:r.mergeAllOf),resolveRef:null===(null==t?void 0:t.refResolver)?null:this.resolveRef})}populate(){this.invokeWalker(this.walker)}invokeWalker(e){const t=e.walk();for(;!t.next().done;);}}export{h as BaseNode,a as MirrorNode,u as ReferenceNode,j as RegularNode,R as RootNode,m as SchemaCombinerName,d as SchemaNodeKind,F as SchemaTree,$ as resolveRef};
//# sourceMappingURL=index.es.js.map
